# 30分钟和月线问题排查指南

## 🔍 问题现状

- ✅ **后端数据查询正常**（已验证，所有周期都有数据）
- ❌ **前端显示异常**（30分钟和月线显示不出来）
- ✅ **日K线和周K线正常**

## 📊 后端验证结果

已通过 `debug_period_issue.py` 验证：

| 周期 | 状态 | 数据量 |
|-----|------|--------|
| 30分钟 | ✅ 正常 | ~464条 |
| 日K线 | ✅ 正常 | ~483条 |
| 周K线 | ✅ 正常 | ~153条 |
| 月K线 | ✅ 正常 | ~60条 |

**结论**：后端SQL查询、数据返回完全正常。

## 🐛 排查步骤

### 步骤1：打开浏览器开发者工具

1. 打开浏览器（Chrome/Edge）
2. 按 **F12** 打开开发者工具
3. 切换到 **Console（控制台）** 标签

### 步骤2：清空控制台并测试

1. 点击控制台左上角的 🚫 清空图标
2. 刷新页面（F5）
3. 选择一只股票
4. 点击 **"30分钟"** 按钮

### 步骤3：查看日志输出

现在控制台会显示详细的调试信息：

**正常情况应该看到：**
```javascript
[30min] 开始渲染K线，数据点数: 464
[30min] ECharts实例已初始化
[30min] 数据准备完成 - 日期数:464, K线数:464, 成交量数:464
[30min] K线渲染成功
```

**如果有错误，会显示：**
```javascript
[30min] K线渲染失败: Error: ...
```

### 步骤4：切换到 Network 标签

1. 切换到 **Network（网络）** 标签
2. 刷新页面并选择股票
3. 点击 "30分钟" 按钮
4. 找到 `kline_data` 请求
5. 查看：
   - **Status**: 应该是 200
   - **Response**: 查看返回的数据
   - **Preview**: 查看数据结构

### 步骤5：检查错误信息

如果控制台有红色错误，请记录：
- 错误消息
- 错误发生的文件和行号
- 错误堆栈

## 🔧 已添加的修复

### 1. 安全的数据处理
```javascript
// 确保analysisData存在
const supportLine = (analysisData && analysisData.supportPrice) ? 
    Array(dates.length).fill(analysisData.supportPrice) : null;
```

### 2. 详细的错误日志
```javascript
console.log(`[${period}] 开始渲染K线，数据点数: ${klineResult.data.length}`);
console.error(`[${period}] K线渲染失败:`, error);
```

### 3. Try-Catch 错误捕获
```javascript
try {
    renderChart(klineResult.data, {}, period);
    console.log(`[${period}] K线渲染成功`);
} catch (error) {
    console.error(`[${period}] K线渲染失败:`, error);
    throw error;
}
```

### 4. 防止重复监听
```javascript
window.removeEventListener('resize', resizeHandler);
window.addEventListener('resize', resizeHandler);
```

## 📝 常见错误及解决

### 错误1：Cannot read properties of null/undefined

**原因**：数据访问异常

**已修复**：所有数据访问都添加了安全检查
```javascript
const liangbi = (latestData && latestData.liangbi) ? latestData.liangbi.toFixed(2) : '--';
```

### 错误2：ECharts初始化失败

**原因**：图表容器不存在

**已修复**：添加了容器检查
```javascript
if (!chartDom) {
    console.error('找不到图表容器 mainChart');
    return;
}
```

### 错误3：数据格式错误

**原因**：后端返回的数据格式不对

**检查方法**：
1. Network标签查看 `kline_data` 响应
2. 确认 `response.data` 是数组
3. 确认数组元素包含 `time`, `open`, `close` 等字段

## 🚀 测试步骤

### 1. 重启后端服务
```bash
# 停止当前服务（Ctrl+C）
start.bat
```

### 2. 完全刷新浏览器
- **硬刷新**: Ctrl + Shift + R
- 或清空缓存后刷新

### 3. 按顺序测试
1. 选择 **国投智能**（波段策略）
2. 查看控制台，应该看到加载日志
3. 点击 **"30分钟"**
4. 观察：
   - 控制台日志
   - K线是否显示
   - 是否有错误

4. 点击 **"月K线"**
5. 同样观察上述内容

### 4. 测试多只股票
- 白云机场（短线）
- 宁德时代（中长线）
- 每只都测试30分钟和月线

## 📊 如何报告问题

如果问题仍然存在，请提供：

### 1. 浏览器信息
- 浏览器类型和版本
- 操作系统

### 2. 控制台输出
```
复制完整的控制台日志，特别是：
- [30min] 开头的日志
- 红色错误信息
- 错误堆栈
```

### 3. Network响应
```
kline_data 请求的响应：
- Status Code
- Response Body（至少前几行）
```

### 4. 截图
- 错误提示截图
- 控制台错误截图
- Network标签截图

## 💡 临时解决方案

如果30分钟和月线始终无法显示，可以：

### 方案1：只使用日K线和周K线
暂时禁用有问题的周期

### 方案2：降级使用
修改前端默认周期为日K线

### 方案3：单独调试
创建简单的测试页面，只加载30分钟数据

## 🔍 深度调试

### 检查数据是否真的返回了

在浏览器控制台手动执行：
```javascript
fetch('http://localhost:5000/api/kline_data', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({
    table_name: 'basic_data_sz300188',
    period_type: '30min'
  })
})
.then(r => r.json())
.then(d => console.log('30分钟数据:', d))
```

### 检查ECharts是否正常
```javascript
// 检查ECharts是否加载
console.log('ECharts版本:', echarts.version);

// 检查图表实例
console.log('当前图表:', chart);
```

## ✅ 预期结果

修复后应该看到：

1. **控制台无错误**
2. **所有周期都能正常显示**
3. **切换流畅无卡顿**
4. **数据正确加载**

## 📞 下一步

1. **重启后端服务**
2. **刷新浏览器**
3. **打开控制台**（F12）
4. **选择股票并测试**
5. **查看控制台日志**
6. **报告结果**

---

**注意**：现在代码已经添加了详细的日志，可以准确定位问题所在！

