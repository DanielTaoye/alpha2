# R点（风险信号）插件系统说明

## 概述

R点插件系统用于检测股票的**卖出信号**（风险信号），与C点（买入信号）对应。当触发任一R点插件时，系统会发出卖出警告。

## 系统架构

### 核心文件
- `backend/domain/services/r_point_plugin_service.py` - R点插件服务

### 工作原理
1. **检查顺序**：按插件优先级依次检查
2. **触发机制**：任一插件触发即返回R点信号
3. **缓存优化**：批量预加载数据，提升性能

## R点插件列表

### 插件1：乖离率偏离 ⚠️

检测股票涨幅过大出现的风险信号。

#### 子条件（满足任一即触发）

| 编号 | 主要条件 | 叠加条件 | 说明 |
|-----|---------|---------|------|
| 1.1 | 连续2个以上涨停 | 放量(XYH) + 空头分歧K线/阴线>3%/5% | 连续涨停后的风险 |
| 1.2 | 前3日涨幅>(15%/20%) | 放量(XYH) + 空头分歧K线/阴线>3%/5% | 短期快速上涨 |
| 1.3 | 前5日涨幅>(20%/25%) | 放量(XYH) + 空头分歧K线/阴线>3%/5% | 中期持续上涨 |
| 1.4 | 连续5连阳+涨幅>(20%/25%) | 放量(XYH) + 空头分歧K线/阴线>3%/5% | 连续上涨动能衰竭 |
| 1.5 | 前15日涨幅>50% | 放量(XYZH) + 空头分歧K线/空头组合 | 中长期大幅上涨 |
| 1.6 | 前20日涨幅>50% | 放量(XYZH) + 空头分歧K线/空头组合 | 长期累计涨幅过大 |

**阈值说明**：
- 主板/非主板：15%/20%、20%/25%
- 涨停：主板≥9.9%，非主板≥19.8%

### 插件2：临近压力位滞涨 📊

检测临近压力位时的滞涨信号。

#### 条件2.1：距离压力位近 + 放量 + 特定K线

**触发条件**：
- 日线赔率 < 15分（距离压力位较近）
- 当日放量（XYZH任意一种）
- 当日K线符合以下任一形态：
  * 振幅>6%/8%的冲高回落（阳线/阴线）
  * 振幅>6%/8%的冲高回落十字星
  * 振幅>6%/8%的高开低走
  * 跌幅>3%的阴线

#### 条件2.2：距离压力位近 + 前3日无放量 + 空头组合

**触发条件**：
- 日线赔率 < 15分
- 前3个交易日未出现(AXYZ)任意一种放量
- 当日出现任意空头组合

### 插件3：基本面突发利空 📉

检测基本面重大利空导致的急跌。

**触发条件**：
- 一字跌停：开=高=低=收
- T字跌停：开=低=收，且有上影线

**说明**：
- 触发后需要AI检测是否存在基本面利空
- 包括但不限于：监管处罚、业绩变脸、重大诉讼等
- TODO: 需要接入AI检测系统

### 插件4：上冲乏力 🚫

检测突破压力位后的乏力信号。

**触发条件**（全部满足）：
1. 从发C日起累计涨幅 > 15%
2. 今日日线赔率 < 25分
3. 前一日涨幅 > 6%/8%（主板/非主板）
4. 今日继续放量（AXYZH任意一种）
5. 今日K线符合以下任一形态：
   - 振幅>6%/8%的冲高回落
   - 振幅>6%/8%的冲高回落十字星
   - 振幅>6%/8%的高开低走
   - 阴线>3%

## K线形态定义

### 1. 空头分歧K线（冲高回落）
- **条件**：振幅 > 6%/8%（主板/非主板）
- **特征**：上影线占比 > 30%
- **含义**：多头发力后被空头打压

### 2. 空头十字星
- **条件**：振幅 > 6%/8%
- **特征**：实体占比 < 1%
- **含义**：高位十字星，多空分歧

### 3. 高开低走
- **条件**：振幅 > 6%/8%
- **特征**：开盘价在高位（>70%），收盘价在低位（<30%）
- **含义**：高开后持续走低

### 4. 阴线超阈值
- **条件**：收盘价 < 开盘价
- **阈值**：跌幅 > 3%或5%
- **含义**：明显的下跌信号

## 成交量类型说明

### 放量类型
- **A**：温和放量（ABCD）
- **X**：异常放量
- **Y**：异常放量
- **Z**：异常放量
- **H**：特殊放量

### 组合使用
- **XYH**：三种异常放量中的任意一种
- **XYZH**：四种放量类型中的任意一种
- **AXYZ**：包括温和放量的四种类型

## 使用示例

### 基本调用
```python
from domain.services.r_point_plugin_service import RPointPluginService

# 创建服务
r_service = RPointPluginService()

# 初始化缓存
r_service.init_cache(stock_code, start_date, end_date)

# 检查R点
is_r_point, plugins = r_service.check_r_point(stock_code, date, c_point_date)

# 清空缓存
r_service.clear_cache()

if is_r_point:
    for plugin in plugins:
        print(f"触发插件: {plugin.plugin_name}")
        print(f"原因: {plugin.reason}")
```

### 在CR点分析中使用
```python
# 检查C点
is_c_point, c_score, c_strategy, c_plugins, base_score, is_rejected = \
    strategy_service.check_c_point_strategy_1(stock_code, kline.time)

# 如果是C点，记录日期
if is_c_point:
    c_point_date = kline.time

# 检查R点
is_r_point, r_plugins = r_service.check_r_point(
    stock_code, 
    kline.time, 
    c_point_date  # 传入C点日期用于"上冲乏力"判断
)
```

## 性能优化

### 1. 批量缓存机制
```python
# 一次性批量加载数据
r_service.init_cache(stock_code, start_date, end_date)

# 后续检查直接从缓存读取，避免重复查询
for date in date_list:
    is_r_point, plugins = r_service.check_r_point(stock_code, date)
```

### 2. 缓存覆盖范围
- daily数据：日线OHLC、成交量
- daily_chance数据：成交量类型、空头组合、赔率分

### 3. 内存管理
- 使用完毕后调用 `clear_cache()` 释放内存
- 建议分批处理大量股票

## 日志输出

触发R点时的日志示例：

```log
[INFO] [R点插件-乖离率偏离] SH600000 2024-11-14: 前5日涨幅23.50%+放量+空头K线
[INFO] [R点插件-临近压力位滞涨] SZ000001 2024-11-14: 距压力位近(赔率12.5)+放量+空头K线
[INFO] [R点插件-上冲乏力] SH600519 2024-11-14: 从C点涨幅18.20%+赔率20.1+昨日涨7.50%+今日放量+空头K线
```

## 测试建议

### 1. 单元测试
- 测试各个K线形态判断函数
- 测试成交量类型判断
- 测试边界条件

### 2. 回测验证
- 使用历史数据验证R点准确性
- 统计R点触发后的下跌概率
- 优化阈值参数

### 3. 实盘测试
- 在模拟盘中测试R点信号
- 结合止损策略使用
- 记录胜率和盈亏比

## 注意事项

1. ⚠️ **综合判断**
   - R点只是风险信号，不是绝对卖出指令
   - 需结合大盘走势、行业情况、个股基本面

2. ⚠️ **参数调整**
   - 阈值可根据市场环境调整
   - 主板/非主板采用不同标准

3. ⚠️ **数据依赖**
   - 需要完整的daily和daily_chance数据
   - 空头组合需要提前计算并存储

4. ⚠️ **插件3待完善**
   - 基本面突发利空插件需要接入AI系统
   - 目前仅检测跌停形态

## 下一步开发

1. ✅ **已完成**
   - R点插件服务基础框架
   - 4个主要插件的实现
   - 缓存优化机制

2. 📝 **待开发**
   - 集成到CR点分析流程
   - 前端展示R点标记
   - AI基本面利空检测
   - 回测验证系统
   - 扫描脚本

3. 🔧 **待优化**
   - 参数可配置化
   - 更多K线形态识别
   - 性能进一步优化

## 相关文档

- `插件5-急跌抢反弹说明.md` - C点插件示例
- `性能优化说明-CR点分析接口.md` - 性能优化说明
- `backend/domain/services/c_point_plugin_service.py` - C点插件服务参考

---

**版本**: v1.0  
**创建时间**: 2024-11-14  
**状态**: 开发完成，待集成测试

