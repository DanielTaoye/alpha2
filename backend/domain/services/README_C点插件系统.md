# C点插件系统 - 计算层设计文档

## 架构设计

### 分层结构

```
基础层（Base Layer）：赔率分 + 胜率分 = 基础分
         ↓
计算层（Plugin Layer）：插件系统（优先级更高）
         ↓
最终分数 >= 70 → 触发C点
```

---

## 插件列表

### 插件1：阴线 ❌一票否决

**规则**：任意阴线当日均不发C

**判断逻辑**：
- 收盘价 < 开盘价 → 阴线
- 触发后直接返回0分，不再检查其他插件

**优先级**：最高（一票否决）

---

### 插件2：赔率高胜率低 📉扣30分

**规则**：如果因赔率较大带来的分值，但成交量和涨幅不理想

**触发条件**（满足任意一条）：

1. **当日成交量未触及放量（ABCD）且涨幅＜2%**
   ```
   volume_type 不包含 A/B/C/D
   AND
   涨幅 < 2%
   ```

2. **前三日+当日均无ABCD**
   ```
   当日 volume_type 不包含 A/B/C/D
   AND
   前3个交易日也都不包含 A/B/C/D
   ```

**分数调整**：-30分

---

### 插件3：风险K线 ❌一票否决

**规则**：冲高回落带明显上影线的阳线不发C

**判断逻辑**：

1. **必须是阳线**（收盘价 >= 开盘价）

2. **振幅过大**：
   - 主板（SH600/601/603/605, SZ000/001）：振幅 > 6%
   - 非主板：振幅 > 8%

3. **有明显上影线**：
   - 上影线比例 > 30%
   ```
   上影线比例 = (最高价 - max(开盘价,收盘价)) / (最高价 - 最低价)
   ```

**优先级**：高（一票否决）

---

### 插件4：不追涨 📉扣50分

**规则**：往前数若干天涨幅过大

**触发条件**（满足任意一条）：

#### 1）连续2个涨停
```
前2日涨幅均 >= 涨停阈值*0.95
- 主板涨停：10%
- 非主板涨停：20%
```

#### 2）前2日累计涨幅过大
```
主板：累计涨幅 > 15%
非主板：累计涨幅 > 25%
```

#### 3）前3日累计涨幅过大
```
主板：累计涨幅 > 20%
非主板：累计涨幅 > 30%
```

#### 4）前5日累计涨幅过大
```
主板：累计涨幅 > 30%
非主板：累计涨幅 > 40%
```

#### 5）前两日连阳且每日涨幅均>5%
```
前2日都是阳线（收盘>=开盘）
AND
前2日涨幅都 > 5%
```

**例外**：股性为短线的股票除外（待实现）

**分数调整**：-50分

---

## 完整计算流程

### 示例1：正常触发C点

```
股票：SH600066
日期：2024-11-01

【基础层】
赔率分：35
成交量类型：A
胜率分：40
基础分：35 + 40 = 75

【计算层-插件检查】
✅ 插件1-阴线：未触发（是阳线）
✅ 插件2-赔率高胜率低：未触发（有A类放量）
✅ 插件3-风险K线：未触发（振幅5%，上影线20%）
✅ 插件4-不追涨：未触发（前3日涨幅正常）

【结果】
最终分：75
是否触发C点：✅ 是（75 >= 70）
触发的插件：[]
```

---

### 示例2：阴线一票否决

```
股票：SH600075
日期：2024-11-02

【基础层】
赔率分：40
成交量类型：B
胜率分：40
基础分：40 + 40 = 80

【计算层-插件检查】
❌ 插件1-阴线：触发！（收盘9.8 < 开盘10.0）
   → 直接返回0分，不再检查其他插件

【结果】
最终分：0
是否触发C点：❌ 否（0 < 70）
触发的插件：["阴线"]
```

---

### 示例3：插件扣分后低于70

```
股票：SH600088
日期：2024-11-03

【基础层】
赔率分：60
成交量类型：X（非ABCD）
胜率分：0
基础分：60 + 0 = 60

【计算层-插件检查】
✅ 插件1-阴线：未触发
❌ 插件2-赔率高胜率低：触发！（无放量且涨幅1.5%）
   → 扣30分
✅ 插件3-风险K线：未触发
❌ 插件4-不追涨：触发！（前2日累计涨幅18%，主板阈值15%）
   → 扣50分

【结果】
最终分：60 - 30 - 50 = -20
是否触发C点：❌ 否（-20 < 70）
触发的插件：["赔率高胜率低", "不追涨"]
```

---

## API返回格式

### C点对象新增字段

```json
{
  "stockCode": "SH600066",
  "triggerDate": "2024-11-01",
  "score": 75,
  "strategyName": "策略一-赔率+胜率综合评分+插件",
  "plugins": [
    {
      "pluginName": "不追涨",
      "triggered": true,
      "scoreAdjustment": -50,
      "reason": "前2日累计涨幅过大 (累计:18.00%, 阈值:15%)"
    }
  ]
}
```

---

## 前端Tooltip显示

### 建议显示格式

```
C点信息：
━━━━━━━━━━━━━━━
📅 日期：2024-11-01
💰 价格：10.50
📊 得分：75 / 70

【基础分】
├─ 赔率分：35
├─ 胜率分：40 (成交量类型: A)
└─ 基础分：75

【插件】
├─ ✅ 阴线检查：通过
├─ ✅ 赔率高胜率低：通过
├─ ✅ 风险K线：通过
└─ ❌ 不追涨：前2日累计涨幅18% (扣50分)

【最终结果】
✅ 触发C点（买入信号）
```

---

## 代码文件

- **插件服务**：`backend/domain/services/c_point_plugin_service.py`
- **策略服务**：`backend/domain/services/cr_strategy_service.py`
- **应用服务**：`backend/application/services/cr_point_service.py`
- **领域模型**：`backend/domain/models/cr_point.py`
- **日线仓储**：`backend/infrastructure/persistence/daily_repository_impl.py`

---

## 待完善功能

1. ⏳ **股性判断**：插件4中"股性为短线的除外"逻辑
2. ⏳ **插件配置化**：允许动态开启/关闭插件
3. ⏳ **插件权重调整**：允许配置扣分值
4. ⏳ **更多插件**：根据业务需求扩展

