# 股票数据同步脚本说明

## 功能说明

`sync_stock_data.py` 脚本用于从生产环境数据库增量同步股票K线数据到本地数据库。

## 特性

- ✅ **增量同步**：只同步本地没有的新数据，避免重复
- ✅ **自动识别**：自动读取股票配置文件，同步所有配置的股票
- ✅ **多周期支持**：支持 30分钟、日线、周线、月线 四种周期
- ✅ **批量处理**：批量插入数据，提高同步效率
- ✅ **错误处理**：完善的错误处理和日志记录
- ✅ **去重处理**：使用 ON DUPLICATE KEY UPDATE 避免重复数据

## 使用方法

### 1. 配置生产环境数据库信息

**方法1：创建配置文件（推荐）**

复制示例配置文件并修改：

```bash
cd backend/scripts
cp sync_config_example.py sync_config.py
```

然后编辑 `sync_config.py`，修改生产环境配置：

```python
PROD_DB_CONFIG = {
    'host': '192.168.1.100',      # 修改为实际的生产环境IP
    'port': 3306,
    'user': 'your_prod_user',     # 修改为实际的用户名
    'password': 'your_prod_password',  # 修改为实际的密码
    'database': 'stock',
    'charset': 'utf8mb4'
}
```

**方法2：直接修改脚本**

编辑 `backend/scripts/sync_stock_data.py` 文件，修改 `PROD_DB_CONFIG` 配置。

### 2. 配置本地数据库信息

如果本地数据库配置与默认不同，修改：

```python
LOCAL_DB_CONFIG = {
    'host': 'localhost',
    'port': 3306,
    'user': 'root',
    'password': '1234',  # 修改为本地数据库密码
    'database': 'stock',
    'charset': 'utf8mb4'
}
```

### 3. 运行同步脚本

```bash
# Windows
cd backend
python scripts/sync_stock_data.py

# Linux/Mac
cd backend
python3 scripts/sync_stock_data.py
```

## 同步逻辑

### 增量同步

1. 对于每个表和周期，脚本会先查询本地数据库中的最大时间
2. 如果本地有数据，只同步大于该时间的新数据
3. 如果本地没有数据，同步最近2年的数据

### 数据去重

使用 MySQL 的 `ON DUPLICATE KEY UPDATE` 语句，如果遇到重复数据（相同的时间和周期），会更新而不是插入。

### 同步范围

- **表范围**：从 `backend/infrastructure/config/stock_config.json` 读取所有配置的股票表
- **周期范围**：30分钟、日线、周线、月线
- **时间范围**：
  - 首次同步：最近2年
  - 增量同步：从上次最大时间开始

## 日志输出

脚本会输出详细的同步日志：

```
============================================================
开始同步股票数据（从生产环境到本地）
============================================================
正在连接生产环境数据库...
✅ 生产环境数据库连接成功
正在连接本地数据库...
✅ 本地数据库连接成功
找到 60 个股票表需要同步

📊 开始同步表: basic_data_sz300188
增量同步 basic_data_sz300188 day: 从 2024-01-01 00:00:00 开始
✅ 同步完成 basic_data_sz300188 day: 150 条新记录
...

============================================================
同步完成！
共同步 5000 条记录，涉及 20 个表/周期组合
============================================================
```

## 注意事项

1. **网络连接**：确保可以访问生产环境数据库
2. **表结构一致**：确保生产环境和本地数据库的表结构一致
3. **主键约束**：表需要有主键或唯一索引（基于 shi_jian 和 peroid_type）
4. **权限要求**：需要生产环境数据库的 SELECT 权限和本地数据库的 INSERT/UPDATE 权限
5. **数据量**：首次同步可能需要较长时间，建议在网络稳定的情况下运行

## 定时同步

可以设置定时任务（cron）定期运行同步脚本：

```bash
# 每天凌晨2点同步
0 2 * * * cd /path/to/backend && python3 scripts/sync_stock_data.py >> logs/sync.log 2>&1
```

## 故障排查

### 连接失败

- 检查生产环境数据库IP、端口、用户名、密码是否正确
- 检查网络连接是否正常
- 检查防火墙设置

### 表不存在

- 检查表名是否正确
- 检查表是否在生产环境和本地都存在

### 同步数据为空

- 检查时间范围是否正确
- 检查生产环境是否有新数据
- 查看日志了解详细信息

