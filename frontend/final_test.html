<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æœ€ç»ˆæµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        h1 { color: #27ae60; }
        button { padding: 15px 30px; margin: 10px 5px; background: #27ae60; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; }
        button:hover { background: #229954; }
        .result { margin: 20px 0; padding: 20px; border-radius: 8px; font-family: monospace; white-space: pre-wrap; font-size: 14px; }
        .success { background: #d4edda; border: 2px solid #28a745; color: #155724; }
        .error { background: #f8d7da; border: 2px solid #dc3545; color: #721c24; }
        .warning { background: #fff3cd; border: 2px solid #ffc107; color: #856404; }
        .info { background: #d1ecf1; border: 2px solid #17a2b8; color: #0c5460; }
        .celebrate { font-size: 48px; text-align: center; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ‰ æœ€ç»ˆæµ‹è¯• - ä½¿ç”¨çœŸå®è‚¡ç¥¨</h1>
        <p>ç°åœ¨ç”¨çœŸå®çš„è‚¡ç¥¨æ•°æ®æµ‹è¯•æ‰¹é‡å›æµ‹åŠŸèƒ½</p>
        
        <button onclick="runCompleteTest()">ğŸš€ è¿è¡Œå®Œæ•´æµ‹è¯•</button>
        <button onclick="testBatchBacktest()">ğŸ“Š æµ‹è¯•æ‰¹é‡å›æµ‹ï¼ˆå‰5æ”¯è‚¡ç¥¨ï¼‰</button>
        
        <div id="result"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:5000/api';
        
        function showResult(message, type = 'info') {
            const resultDiv = document.getElementById('result');
            const timestamp = new Date().toLocaleTimeString();
            resultDiv.innerHTML = `<div class="result ${type}">[${timestamp}]\n${message}</div>`;
        }
        
        async function runCompleteTest() {
            showResult('å¼€å§‹å®Œæ•´æµ‹è¯•æµç¨‹...\n', 'info');
            
            try {
                // æ­¥éª¤1: è·å–è‚¡ç¥¨åˆ—è¡¨
                showResult('æ­¥éª¤1/3: è·å–è‚¡ç¥¨åˆ—è¡¨...', 'info');
                const stocksResponse = await fetch(API_BASE_URL + '/stock_groups');
                const stocksData = await stocksResponse.json();
                
                if (stocksData.code !== 200) {
                    throw new Error('è·å–è‚¡ç¥¨åˆ—è¡¨å¤±è´¥: ' + stocksData.message);
                }
                
                const strategies = Object.keys(stocksData.data);
                const firstStrategy = strategies[0];
                const stock = stocksData.data[firstStrategy][0];
                
                showResult(`âœ… æ­¥éª¤1å®Œæˆ
æ‰¾åˆ°ç­–ç•¥: ${strategies.join(', ')}
æµ‹è¯•è‚¡ç¥¨: ${stock.name} (${stock.code})
è¡¨å: ${stock.table_name}

æ­¥éª¤2/3: æµ‹è¯•CRåˆ†æ...`, 'info');
                
                // æ­¥éª¤2: æµ‹è¯•CRåˆ†æ
                const crResponse = await fetch(API_BASE_URL + '/cr_analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        stockCode: stock.code,
                        stockName: stock.name,
                        tableName: stock.table_name,
                        period: 'day'
                    })
                });
                
                const crData = await crResponse.json();
                
                if (crResponse.status === 500) {
                    showResult(`âš ï¸ CRåˆ†æè¿”å›500é”™è¯¯ï¼ˆè¿™å¯èƒ½æ˜¯æ­£å¸¸çš„ä¸šåŠ¡é”™è¯¯ï¼‰

çŠ¶æ€ç : ${crResponse.status}
è¿”å›æ•°æ®: ${JSON.stringify(crData, null, 2)}

å¸¸è§åŸå› ï¼š
- è¯¥è‚¡ç¥¨æ²¡æœ‰Kçº¿æ•°æ®
- æ•°æ®åº“è¡¨ä¸å­˜åœ¨
- æ•°æ®æ ¼å¼é—®é¢˜

è®©æˆ‘ä»¬å°è¯•ä¸‹ä¸€æ”¯è‚¡ç¥¨...`, 'warning');
                    
                    // å°è¯•ç¬¬äºŒæ”¯è‚¡ç¥¨
                    if (stocksData.data[firstStrategy].length > 1) {
                        const stock2 = stocksData.data[firstStrategy][1];
                        showResult(`å°è¯•ç¬¬äºŒæ”¯è‚¡ç¥¨: ${stock2.name} (${stock2.code})...`, 'info');
                        
                        const cr2Response = await fetch(API_BASE_URL + '/cr_analysis', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                stockCode: stock2.code,
                                stockName: stock2.name,
                                tableName: stock2.table_name,
                                period: 'day'
                            })
                        });
                        
                        const cr2Data = await cr2Response.json();
                        
                        if (cr2Response.ok) {
                            showResult(`<div class="celebrate">ğŸ‰ğŸ‰ğŸ‰</div>

âœ…âœ…âœ… å®Œå…¨æˆåŠŸï¼âœ…âœ…âœ…

CRåˆ†æå·¥ä½œæ­£å¸¸ï¼
è‚¡ç¥¨: ${stock2.name} (${stock2.code})
Cç‚¹æ•°é‡: ${cr2Data.data?.c_points?.length || 0}
Rç‚¹æ•°é‡: ${cr2Data.data?.r_points?.length || 0}

<strong>æ‰¹é‡å›æµ‹åŠŸèƒ½å·²ç»å¯ä»¥æ­£å¸¸ä½¿ç”¨äº†ï¼</strong>

ç°åœ¨å¯ä»¥è®¿é—®:
http://localhost:5000/batch_backtest.html

ä½¿ç”¨æ­¥éª¤ï¼š
1. é€‰æ‹©è‚¡æ€§åˆ†ç»„ï¼ˆæˆ–"æ‰€æœ‰ç­–ç•¥"ï¼‰
2. è®¾ç½®è‚¡ç¥¨æ•°é‡ï¼ˆå»ºè®®å…ˆæµ‹è¯•5æ”¯ï¼‰
3. ç‚¹å‡»"å¼€å§‹æ‰¹é‡å›æµ‹"
4. ç­‰å¾…ç»“æœ

æ³¨æ„ï¼šæŸäº›è‚¡ç¥¨å¯èƒ½ä¼šå¤±è´¥ï¼ˆæ²¡æœ‰æ•°æ®ç­‰ï¼‰ï¼Œè¿™æ˜¯æ­£å¸¸çš„ã€‚
ç³»ç»Ÿä¼šåœ¨ç»“æœä¸­æ˜¾ç¤ºæˆåŠŸå’Œå¤±è´¥çš„æ•°é‡ã€‚`, 'success');
                        } else {
                            showResult(`ç¬¬äºŒæ”¯è‚¡ç¥¨ä¹Ÿå¤±è´¥äº†ã€‚
é”™è¯¯: ${JSON.stringify(cr2Data, null, 2)}

å»ºè®®ç›´æ¥æµ‹è¯•æ‰¹é‡å›æµ‹ï¼Œå®ƒä¼šè‡ªåŠ¨è·³è¿‡å¤±è´¥çš„è‚¡ç¥¨ã€‚`, 'warning');
                        }
                    }
                    return;
                }
                
                if (crData.code !== 200) {
                    throw new Error('CRåˆ†æå¤±è´¥: ' + crData.message);
                }
                
                const cPoints = crData.data.c_points || [];
                const rPoints = crData.data.r_points || [];
                
                showResult(`âœ… æ­¥éª¤2å®Œæˆ
Cç‚¹æ•°é‡: ${cPoints.length}
Rç‚¹æ•°é‡: ${rPoints.length}

æ­¥éª¤3/3: æµ‹è¯•å›æµ‹åŠŸèƒ½...`, 'info');
                
                // æ­¥éª¤3: æµ‹è¯•å›æµ‹
                if (cPoints.length > 0) {
                    const backtestResponse = await fetch(API_BASE_URL + '/backtest', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            stockCode: stock.code,
                            tableName: stock.table_name,
                            cPoints: cPoints,
                            rPoints: rPoints
                        })
                    });
                    
                    const backtestData = await backtestResponse.json();
                    
                    if (backtestData.code === 200) {
                        const summary = backtestData.data.summary;
                        showResult(`<div class="celebrate">ğŸ‰ğŸ‰ğŸ‰</div>

âœ…âœ…âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼âœ…âœ…âœ…

è‚¡ç¥¨: ${stock.name} (${stock.code})
æ€»äº¤æ˜“æ¬¡æ•°: ${summary.total_trades}
å¹³å‡æ”¶ç›Šç‡: ${summary.avg_return}%
èƒœç‡: ${summary.win_rate}%

<strong>æ‰¹é‡å›æµ‹åŠŸèƒ½å®Œå…¨æ­£å¸¸ï¼</strong>

ç°åœ¨å¯ä»¥è®¿é—®:
http://localhost:5000/batch_backtest.html

å¼€å§‹ä½¿ç”¨æ‰¹é‡å›æµ‹åŠŸèƒ½ï¼`, 'success');
                    } else {
                        showResult(`âš ï¸ å›æµ‹è¿”å›é”™è¯¯ï¼ˆå¯èƒ½æ˜¯ç¼ºå°‘30åˆ†é’Ÿæ•°æ®ï¼‰

é”™è¯¯ä¿¡æ¯: ${backtestData.message}

è¿™å¯èƒ½æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºè¯¥è‚¡ç¥¨å¯èƒ½æ²¡æœ‰30åˆ†é’ŸKçº¿æ•°æ®ã€‚
æ‰¹é‡å›æµ‹ä¼šè‡ªåŠ¨è·³è¿‡è¿™äº›è‚¡ç¥¨ã€‚`, 'warning');
                    }
                } else {
                    showResult(`âš ï¸ è¯¥è‚¡ç¥¨æ²¡æœ‰Cç‚¹ï¼Œæ— æ³•æµ‹è¯•å›æµ‹åŠŸèƒ½ã€‚

è¿™æ˜¯æ­£å¸¸ç°è±¡ï¼Œè¯´æ˜è¯¥è‚¡ç¥¨å½“å‰æ²¡æœ‰ä¹°å…¥ä¿¡å·ã€‚
æ‰¹é‡å›æµ‹ä¼šè‡ªåŠ¨è·³è¿‡æ²¡æœ‰Cç‚¹çš„è‚¡ç¥¨ã€‚

<strong>APIåŠŸèƒ½æ­£å¸¸ï¼Œå¯ä»¥ä½¿ç”¨æ‰¹é‡å›æµ‹äº†ï¼</strong>`, 'warning');
                }
                
            } catch (error) {
                showResult(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}

è¯·æ£€æŸ¥åç«¯æ—¥å¿—æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚`, 'error');
            }
        }
        
        async function testBatchBacktest() {
            showResult('å¼€å§‹æ¨¡æ‹Ÿæ‰¹é‡å›æµ‹ï¼ˆå‰5æ”¯è‚¡ç¥¨ï¼‰...\n', 'info');
            
            try {
                const stocksResponse = await fetch(API_BASE_URL + '/stock_groups');
                const stocksData = await stocksResponse.json();
                
                if (stocksData.code !== 200) {
                    throw new Error('è·å–è‚¡ç¥¨åˆ—è¡¨å¤±è´¥');
                }
                
                const strategies = Object.keys(stocksData.data);
                const firstStrategy = strategies[0];
                const stocks = stocksData.data[firstStrategy].slice(0, 5);
                
                let results = [];
                let successCount = 0;
                let failCount = 0;
                
                for (let i = 0; i < stocks.length; i++) {
                    const stock = stocks[i];
                    showResult(`æµ‹è¯•è¿›åº¦: ${i + 1}/${stocks.length}
å½“å‰è‚¡ç¥¨: ${stock.name} (${stock.code})...`, 'info');
                    
                    try {
                        const crResponse = await fetch(API_BASE_URL + '/cr_analysis', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                stockCode: stock.code,
                                stockName: stock.name,
                                tableName: stock.table_name,
                                period: 'day'
                            })
                        });
                        
                        const crData = await crResponse.json();
                        
                        if (crData.code === 200 && crData.data.c_points && crData.data.c_points.length > 0) {
                            successCount++;
                            results.push(`âœ… ${stock.name}: ${crData.data.c_points.length}ä¸ªCç‚¹`);
                        } else {
                            failCount++;
                            results.push(`âš ï¸ ${stock.name}: ${crData.message || 'æ²¡æœ‰Cç‚¹'}`);
                        }
                    } catch (error) {
                        failCount++;
                        results.push(`âŒ ${stock.name}: ${error.message}`);
                    }
                }
                
                showResult(`<div class="celebrate">âœ… æ‰¹é‡æµ‹è¯•å®Œæˆ</div>

æ€»è®¡: ${stocks.length}æ”¯è‚¡ç¥¨
æˆåŠŸ: ${successCount}æ”¯
å¤±è´¥: ${failCount}æ”¯

è¯¦ç»†ç»“æœ:
${results.join('\n')}

<strong>ç»“è®ºï¼š</strong>
æ‰¹é‡å›æµ‹åŠŸèƒ½${successCount > 0 ? 'æ­£å¸¸å·¥ä½œ' : 'éœ€è¦æ£€æŸ¥'}ï¼

${successCount > 0 ? `ç°åœ¨å¯ä»¥è®¿é—®æ‰¹é‡å›æµ‹é¡µé¢:
http://localhost:5000/batch_backtest.html` : 'è¯·æ£€æŸ¥è‚¡ç¥¨æ•°æ®æ˜¯å¦æ­£ç¡®å¯¼å…¥ã€‚'}`, successCount > 0 ? 'success' : 'warning');
                
            } catch (error) {
                showResult(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>

