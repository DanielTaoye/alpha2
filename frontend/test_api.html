<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIæµ‹è¯•å·¥å…·</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
        button { padding: 10px 20px; margin: 10px 5px; background: #4a90e2; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #357abd; }
        pre { background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto; }
        .success { color: #27ae60; }
        .error { color: #e74c3c; }
        .info { color: #3498db; }
    </style>
</head>
<body>
    <h1>ğŸ”§ APIæµ‹è¯•å·¥å…·</h1>
    <p>ç”¨äºæµ‹è¯•æ‰¹é‡å›æµ‹åŠŸèƒ½çš„APIæ¥å£</p>
    
    <div>
        <button onclick="testStockGroups()">1ï¸âƒ£ æµ‹è¯•è·å–è‚¡ç¥¨åˆ†ç»„</button>
        <button onclick="testCRAnalysis()">2ï¸âƒ£ æµ‹è¯•CRåˆ†æ</button>
        <button onclick="testBacktest()">3ï¸âƒ£ æµ‹è¯•å›æµ‹</button>
        <button onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
    </div>
    
    <h3>æµ‹è¯•ç»“æœï¼š</h3>
    <pre id="log">ç­‰å¾…æµ‹è¯•...</pre>

    <script>
        const API_BASE_URL = 'http://localhost:5000/api';
        let testStock = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').textContent = 'ç­‰å¾…æµ‹è¯•...';
        }

        async function testStockGroups() {
            log('=== æµ‹è¯•1: è·å–è‚¡ç¥¨åˆ†ç»„ ===');
            
            try {
                log('å‘é€è¯·æ±‚åˆ°: ' + API_BASE_URL + '/stock_groups');
                const response = await fetch(API_BASE_URL + '/stock_groups');
                
                log('å“åº”çŠ¶æ€: ' + response.status + ' ' + response.statusText);
                log('Content-Type: ' + response.headers.get('content-type'));
                
                if (!response.ok) {
                    const text = await response.text();
                    log('é”™è¯¯å“åº”: ' + text.substring(0, 300), 'error');
                    return;
                }
                
                const result = await response.json();
                log('âœ… æˆåŠŸè·å–è‚¡ç¥¨åˆ†ç»„', 'success');
                log('è¿”å›ä»£ç : ' + result.code);
                
                if (result.code === 200 && result.data) {
                    const strategies = Object.keys(result.data);
                    log('æ‰¾åˆ°ç­–ç•¥: ' + strategies.join(', '));
                    
                    for (const strategy of strategies) {
                        log(`  - ${strategy}: ${result.data[strategy].length}æ”¯è‚¡ç¥¨`);
                    }
                    
                    // ä¿å­˜ç¬¬ä¸€ä¸ªè‚¡ç¥¨ç”¨äºæµ‹è¯•
                    const firstStrategy = strategies[0];
                    testStock = result.data[firstStrategy][0];
                    log('å·²ä¿å­˜æµ‹è¯•è‚¡ç¥¨: ' + testStock.name + ' (' + testStock.code + ')', 'success');
                    log('è¡¨å: ' + testStock.table_name);
                } else {
                    log('è¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸', 'error');
                    log(JSON.stringify(result, null, 2));
                }
                
            } catch (error) {
                log('âŒ æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
                console.error(error);
            }
        }

        async function testCRAnalysis() {
            log('\n=== æµ‹è¯•2: CRåˆ†æ ===');
            
            if (!testStock) {
                log('âŒ è¯·å…ˆè¿è¡Œæµ‹è¯•1è·å–è‚¡ç¥¨æ•°æ®', 'error');
                return;
            }
            
            try {
                const requestBody = {
                    stockCode: testStock.code,
                    stockName: testStock.name,
                    tableName: testStock.table_name,
                    period: 'day'
                };
                
                log('æµ‹è¯•è‚¡ç¥¨: ' + testStock.name + ' (' + testStock.code + ')');
                log('è¯·æ±‚å‚æ•°: ' + JSON.stringify(requestBody, null, 2));
                log('å‘é€è¯·æ±‚åˆ°: ' + API_BASE_URL + '/cr_analysis');
                
                const response = await fetch(API_BASE_URL + '/cr_analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                log('å“åº”çŠ¶æ€: ' + response.status + ' ' + response.statusText);
                log('Content-Type: ' + response.headers.get('content-type'));
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    log('âŒ APIè¿”å›éJSONå“åº”', 'error');
                    log('å“åº”å†…å®¹: ' + text.substring(0, 500), 'error');
                    return;
                }
                
                const result = await response.json();
                log('è¿”å›ä»£ç : ' + result.code);
                
                if (result.code === 200) {
                    log('âœ… CRåˆ†ææˆåŠŸ', 'success');
                    log('Cç‚¹æ•°é‡: ' + (result.data.c_points ? result.data.c_points.length : 0));
                    log('Rç‚¹æ•°é‡: ' + (result.data.r_points ? result.data.r_points.length : 0));
                } else {
                    log('âŒ CRåˆ†æå¤±è´¥: ' + result.message, 'error');
                }
                
            } catch (error) {
                log('âŒ æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
                console.error(error);
            }
        }

        async function testBacktest() {
            log('\n=== æµ‹è¯•3: å›æµ‹åŠŸèƒ½ ===');
            
            if (!testStock) {
                log('âŒ è¯·å…ˆè¿è¡Œæµ‹è¯•1è·å–è‚¡ç¥¨æ•°æ®', 'error');
                return;
            }
            
            try {
                log('æ­¥éª¤1: è·å–CRç‚¹æ•°æ®...');
                
                // å…ˆè·å–CRç‚¹
                const crResponse = await fetch(API_BASE_URL + '/cr_analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        stockCode: testStock.code,
                        stockName: testStock.name,
                        tableName: testStock.table_name,
                        period: 'day'
                    })
                });
                
                const crResult = await crResponse.json();
                
                if (crResult.code !== 200) {
                    log('âŒ è·å–CRç‚¹å¤±è´¥: ' + crResult.message, 'error');
                    return;
                }
                
                const cPoints = crResult.data.c_points || [];
                const rPoints = crResult.data.r_points || [];
                log(`æ‰¾åˆ°Cç‚¹${cPoints.length}ä¸ª, Rç‚¹${rPoints.length}ä¸ª`);
                
                if (cPoints.length === 0) {
                    log('âš ï¸ è¯¥è‚¡ç¥¨æ²¡æœ‰Cç‚¹ï¼Œæ— æ³•æµ‹è¯•å›æµ‹', 'error');
                    return;
                }
                
                log('æ­¥éª¤2: æ‰§è¡Œå›æµ‹...');
                
                const backtestResponse = await fetch(API_BASE_URL + '/backtest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        stockCode: testStock.code,
                        tableName: testStock.table_name,
                        cPoints: cPoints,
                        rPoints: rPoints
                    })
                });
                
                const backtestResult = await backtestResponse.json();
                
                if (backtestResult.code === 200) {
                    log('âœ… å›æµ‹æˆåŠŸ', 'success');
                    const summary = backtestResult.data.summary;
                    log('æ€»äº¤æ˜“æ¬¡æ•°: ' + summary.total_trades);
                    log('å¹³å‡æ”¶ç›Šç‡: ' + summary.avg_return + '%');
                    log('èƒœç‡: ' + summary.win_rate + '%');
                } else {
                    log('âŒ å›æµ‹å¤±è´¥: ' + backtestResult.message, 'error');
                }
                
            } catch (error) {
                log('âŒ æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
                console.error(error);
            }
        }
    </script>
</body>
</html>

