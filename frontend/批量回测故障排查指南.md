# 批量回测故障排查指南

## 🔍 问题：✗ 失败 - API返回格式错误

这个错误通常表示后端API返回的不是JSON格式，而是HTML错误页面。

## ✅ 解决步骤

### 步骤1: 确认后端服务已重启

**非常重要！** 新添加的API路由必须重启服务才能生效。

1. 关闭当前运行的后端服务（在命令行窗口按 Ctrl+C）
2. 重新运行 `start.bat`
3. 等待服务完全启动（看到"Running on http://..."的提示）

### 步骤2: 使用测试工具诊断

1. 在浏览器中打开：`http://localhost:5000/test_api.html`
2. 按顺序点击测试按钮：
   - **1️⃣ 测试获取股票分组** - 确认基础API工作正常
   - **2️⃣ 测试CR分析** - 确认CR分析API正常
   - **3️⃣ 测试回测** - 确认回测功能正常

3. 查看测试结果：
   - ✅ 绿色 = 成功
   - ❌ 红色 = 失败
   - 📋 蓝色 = 信息

### 步骤3: 检查浏览器控制台

1. 在批量回测页面按 `F12` 打开开发者工具
2. 切换到 `Console` (控制台) 标签
3. 点击"开始批量回测"
4. 查看详细的日志输出：
   - 请求参数
   - 响应状态
   - Content-Type
   - 具体错误信息

### 步骤4: 检查后端日志

查看后端命令行窗口的输出，寻找：
- Python错误堆栈
- 500错误
- 导入错误
- 数据库连接错误

## 🐛 常见问题及解决方案

### 问题1: 404 Not Found

**原因**: API路由未注册或后端未重启

**解决方案**:
```bash
# 重启后端服务
1. 关闭当前服务 (Ctrl+C)
2. 运行: start.bat
```

### 问题2: 500 Internal Server Error

**原因**: 后端代码错误或数据库问题

**解决方案**:
1. 检查后端命令行窗口的错误信息
2. 确认数据库连接正常
3. 确认股票表数据存在

### 问题3: CORS错误

**原因**: 跨域请求被阻止

**解决方案**:
- 确认后端已安装 `flask-cors`
- 确认 `CORS(app)` 已配置

### 问题4: 某些股票一直显示"失败"

**原因**: 
- 该股票没有30分钟K线数据
- 该股票没有C点
- 数据库表不存在

**解决方案**:
- 这是正常现象，跳过这些股票
- 系统会在结果中显示失败原因

## 📊 查看详细调试信息

批量回测页面现在包含详细的控制台日志：

1. 按 F12 打开开发者工具
2. 选择 Console 标签
3. 你会看到每个股票的详细信息：
   ```
   开始回测股票: 600519 贵州茅台
   CR分析请求参数: {stockCode: "600519", ...}
   CR分析响应状态: 200 OK
   CR分析响应Content-Type: application/json
   找到C点3个, R点2个
   ...
   ```

## 🎯 验证功能正常

如果一切正常，你应该看到：

1. **进度条** 实时更新
2. **汇总卡片** 显示统计数据（平均收益率、总交易次数等）
3. **详细表格** 显示每支股票的回测结果

## 💡 提示

- 第一次运行可能较慢，因为需要分析所有股票的CR点
- 建议先用较小的股票数量（5-10支）测试
- 如果某些股票失败，查看表格中的失败原因

## 📞 仍然无法解决？

请提供以下信息：

1. 浏览器控制台的完整错误信息（F12 -> Console）
2. 后端命令行窗口的错误日志
3. 测试工具（test_api.html）的测试结果
4. 选择的股性类型和股票数量

