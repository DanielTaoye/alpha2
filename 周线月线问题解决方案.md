# 周线月线K线显示问题解决方案

## 🐛 问题描述

有些股票切换到周K线或月K线时显示不出来，报错：
```
Cannot read properties of null (reading 'removeChild')
```

## 🔍 问题原因

### 1. 周期类型映射错误
之前的配置：
```python
PERIOD_TYPE_MAP = {
    '30min': '30min',
    'day': '1day',
    'week': 'week',
    'month': 'month'
}
```

实际数据库中的 `peroid_type` 字段使用的是**数字**：
- `4` : 30分钟K线
- `6` : 日K线
- `7` : 周K线
- `8` : 月K线

### 2. 数据库可能缺少周期数据
如果导入数据时只导入了日K线数据，那么周线和月线就没有数据。

## ✅ 解决方案

### 1. 已修复周期映射（backend/app.py）

```python
# 周期类型映射（根据数据库实际字段值）
# 4: 30分钟, 6: 日线, 7: 周线, 8: 月线
PERIOD_TYPE_MAP = {
    '30min': '4',
    'day': '6',
    'week': '7',
    'month': '8'
}
```

### 2. 已优化前端错误处理

当没有数据时会显示友好提示：
```
📊 暂无周K线数据
该股票可能没有周K线的K线数据
请尝试切换其他周期
```

## 🔧 验证数据库

运行检查脚本：

```bash
python check_period_types.py
```

这个脚本会显示数据库中实际的周期类型值和数据量。

## 📊 手动检查数据库

```sql
-- 连接数据库
mysql -u root -p stock

-- 检查某个表的周期类型
SELECT peroid_type, COUNT(*) as count 
FROM basic_data_sz300188 
GROUP BY peroid_type;

-- 应该看到类似：
-- peroid_type | count
-- ------------|-------
--      4      | 2000   (30分钟)
--      6      | 500    (日线)
--      7      | 100    (周线)
--      8      | 36     (月线)
```

## 🚀 重启服务

修改后需要重启后端服务：

```bash
# 停止当前服务（Ctrl+C）
# 重新启动
start.bat
```

或

```bash
cd backend
python app.py
```

## ✨ 测试步骤

1. 重启后端服务
2. 刷新浏览器页面
3. 选择一只股票
4. 点击"周K线"按钮
   - 如果有数据：显示周K线图
   - 如果没数据：显示友好提示
5. 点击"月K线"按钮
   - 同上

## 📝 如果仍然没有数据

### 情况1：数据库中确实没有周线/月线数据

**原因**：导入数据时可能只导入了日K线数据

**解决方案**：
需要重新从生产环境导入完整数据，包括所有周期。

修改 `import_stocks_from_prod.py`，确保导入所有周期的数据。

### 情况2：周期类型字段名不同

**检查**：
```sql
-- 查看表结构
DESC basic_data_sz300188;

-- 周期字段可能叫：
-- peroid_type
-- period_type
-- kline_type
-- 等等
```

**解决**：修改 `backend/app.py` 中的 SQL 查询字段名。

### 情况3：周期类型值不是数字

**检查**：
```sql
SELECT DISTINCT peroid_type FROM basic_data_sz300188;
```

可能的值：
- 字符串: '30min', 'day', 'week', 'month'
- 数字: 4, 6, 7, 8
- 中文: '30分钟', '日线', '周线', '月线'

**解决**：根据实际值调整 `PERIOD_TYPE_MAP`。

## 🎯 快速诊断命令

```bash
# 1. 检查周期类型
python check_period_types.py

# 2. 如果确认映射正确但仍无数据
#    查看后端日志，看SQL查询是否正确

# 3. 检查数据库连接
python test_local_db.py
```

## 💡 常见问题

### Q1: 为什么日K线能显示，周线月线不行？

**A**: 因为日K线的数据最全，而周线月线数据可能：
- 没有导入
- 字段值不匹配
- 数据量太少（少于最小显示要求）

### Q2: 所有股票都不显示周线月线吗？

**A**: 测试多只股票：
- 如果都不显示：周期映射或数据库配置问题
- 如果部分显示：个别股票数据缺失

### Q3: 如何确认修复成功？

**A**: 
1. 后端启动无错误
2. 浏览器控制台无错误
3. 至少一只股票能显示周K线
4. 点击月K线有数据或有友好提示

## 📞 还有问题？

1. 运行 `check_period_types.py` 查看输出
2. 查看浏览器控制台（F12）的错误信息
3. 查看后端日志输出
4. 提供错误截图和日志

---

**注意**：修改后必须重启后端服务才能生效！

