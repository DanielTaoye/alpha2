# 回测功能说明

## 功能概述

回测功能可以计算股票按照C点买入、R点卖出策略的历史收益率。

## 功能特点

1. **C点买入规则**：当触发C点后，在第二天第一根30分钟K线的开盘价买入
2. **R点卖出规则**：当触发R点后，在第二天第一根30分钟K线的开盘价卖出
3. **交易配对逻辑**：每个C点配对其后的第一个R点
4. **多策略支持**：如果同一天有多个C点（不同策略），系统会自动处理

## 使用方法

1. 在主界面选择一只股票
2. 等待K线图和CR点数据加载完成
3. 点击K线图下方的"📊 运行回测"按钮
4. 查看回测结果

## 回测结果展示

### 汇总统计
- **总交易次数**：所有C点触发的交易数
- **已完成交易**：有对应R点的交易数
- **持仓中**：没有对应R点的交易数（还未卖出）
- **胜率**：盈利交易占已完成交易的比例
- **平均收益率**：所有已完成交易的平均收益
- **累计收益率**：所有已完成交易的收益总和
- **最大收益**：单笔最高收益率
- **最大亏损**：单笔最大亏损率
- **平均持仓天数**：从C点到R点的平均天数
- **盈利/亏损笔数**：分别统计盈利和亏损的交易次数

### 交易明细
详细显示每一笔交易的信息：
- 序号
- C点日期
- 买入策略（策略1或策略2）
- 买入价
- R点日期
- 卖出价
- 收益率（%）
- 持仓天数
- 状态（已完成/持仓中）

## 技术实现

### 后端API
- **路径**：`/api/backtest`
- **方法**：POST
- **参数**：
  - `stockCode`: 股票代码
  - `tableName`: 数据表名
  - `cPoints`: C点列表
  - `rPoints`: R点列表

### 核心逻辑
1. 接收前端传来的CR点数据
2. 按日期排序C点和R点
3. 为每个C点寻找其后的第一个R点
4. 从数据库查询对应的30分钟K线数据
5. 计算买入价（C点后第二天第一根30分钟K线开盘价）
6. 计算卖出价（R点后第二天第一根30分钟K线开盘价）
7. 计算收益率：`(卖出价 - 买入价) / 买入价 * 100%`
8. 统计汇总数据

## 数据来源

- 所有数据来自数据库表：`basic_stock_股票代码`
- 30分钟K线的`peroid_type = 2`
- 买卖价格都取自30分钟K线的`kai_pan_jia`字段

## 注意事项

1. 回测结果仅基于历史数据，不构成投资建议
2. 实际交易中可能存在滑点、手续费等因素未在回测中体现
3. 如果C点后没有匹配的R点，该交易会显示为"持仓中"
4. 回测使用第二天的开盘价，避免了使用未来数据

