# 回测问题排查指南

## 问题现象
点击"运行回测"按钮后，显示"无法生成回测数据"。

## 可能原因及解决方案

### 1. 数据库中没有30分钟K线数据 ⭐ 最常见

**检查方法：**

运行检查脚本：
```bash
cd backend/scripts
python check_30min_data.py <股票代码>

# 例如：
python check_30min_data.py 600000
```

**输出示例：**
```
============================================================
检查表: basic_stock_600000
============================================================

✅ 表 basic_stock_600000 存在

周期类型统计:
----------------------------------------
  peroid_type=1 (日K线): 1234条
  peroid_type=2 (30分钟K线): 8976条    ← 这个是关键！
  peroid_type=3 (周K线): 234条
  peroid_type=4 (月K线): 56条
```

**如果没有30分钟数据：**
- 该股票无法进行回测
- 需要重新同步该股票的数据，确保包含30分钟K线
- 检查数据源是否提供30分钟K线

### 2. C点后没有30分钟K线数据

**查看后端日志：**
```bash
tail -f logs/app.log
```

**日志关键信息：**
```
[INFO] 开始回测: 股票代码=600000, 表名=basic_stock_600000
[INFO] C点数量: 3, R点数量: 5
[INFO] 表basic_stock_600000中30分钟K线数据（peroid_type=2）数量: 8976
[INFO] 处理第1个C点: 2024-01-15, 策略: 策略一
[INFO] 查询2024-01-15后的30分钟K线开盘价...
[INFO]   表名: basic_stock_600000
[INFO]   查询条件: peroid_type=2 AND shi_jian >= '2024-01-16 00:00:00'
[INFO] ✅ 找到2024-01-15后的30分钟K线:
[INFO]   时间: 2024-01-16 09:30:00
[INFO]   开盘价: 12.34
[INFO]   周期类型: 2
```

**如果看到警告：**
```
[WARNING] ⚠️ 未找到2024-01-15后的30分钟K线数据
[WARNING]   该日期后总K线数: 0
```
说明C点触发日期之后没有数据了（可能是最新的C点）。

### 3. 查看前端控制台日志

打开浏览器开发者工具（F12），查看Console：

```javascript
============================================================
开始回测:
  股票代码: 600000
  表名: basic_stock_600000
  C点数量: 3
  R点数量: 5
  C点详情: [{triggerDate: "2024-01-15", ...}, ...]
  R点详情: [{triggerDate: "2024-02-10", ...}, ...]
```

## 快速测试步骤

### 步骤1：检查是否在日K线
- 确保当前显示的是**日K线**，不是30分钟/周线/月线
- 回测按钮应该是可点击状态（不是灰色）

### 步骤2：检查是否有C点数据
- 在K线图上方查看"CR点(买入): X | R点(卖出): Y"
- 如果C点数量为0，说明该股票没有触发买入信号
- 可以选择其他股票尝试

### 步骤3：运行数据检查脚本
```bash
cd backend/scripts
python check_30min_data.py <你的股票代码>
```

### 步骤4：查看详细日志
```bash
# 清空日志（可选）
echo "" > logs/app.log

# 实时查看日志
tail -f logs/app.log

# 然后在前端点击"运行回测"按钮
```

## 常见问题

### Q1: 提示"该股票数据库中没有30分钟K线数据"
**A:** 这个股票的数据表中没有`peroid_type=2`的数据。需要：
1. 检查数据同步脚本是否包含30分钟周期
2. 重新同步该股票数据
3. 或选择其他有30分钟数据的股票

### Q2: 有C点但回测结果为空
**A:** 可能原因：
1. C点触发日期太新，之后没有30分钟数据
2. C点和R点之间缺少30分钟数据
3. 查看后端日志确认具体原因

### Q3: 部分C点有回测数据，部分没有
**A:** 这是正常的，可能：
1. 某些C点还未出现对应的R点（显示为"持仓中"）
2. 某些C点之后的30分钟数据缺失（会跳过）

## 数据表结构说明

回测功能需要的数据：
```sql
表名: basic_stock_<股票代码>
必需字段:
  - shi_jian (datetime): K线时间
  - kai_pan_jia (decimal): 开盘价
  - peroid_type (int): 周期类型
    - 1: 日K线
    - 2: 30分钟K线 ← 回测必需
    - 3: 周K线
    - 4: 月K线
```

## 联系支持

如果以上方法都无法解决，请提供：
1. 股票代码
2. 后端日志（logs/app.log 中的回测相关部分）
3. 前端控制台截图
4. check_30min_data.py 脚本的输出

