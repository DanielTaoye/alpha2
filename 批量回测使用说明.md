# 批量回测使用说明

## ⚠️ 重要提示

**405错误已修复！** 现在请按以下步骤操作：

## 🔧 修复步骤

### 1. 重启后端服务（必须！）

```bash
# 在后端命令行窗口
1. 按 Ctrl+C 停止当前服务
2. 重新运行: start.bat
3. 等待看到 "Running on http://127.0.0.1:5000" 的提示
```

**为什么必须重启？**
- 新添加的API路由需要重启服务才能生效
- CORS配置已更新，需要重新加载
- OPTIONS方法支持已添加

### 2. 测试API是否正常

打开测试页面：`http://localhost:5000/test_api.html`

依次测试：
1. 点击 **"1️⃣ 测试获取股票分组"**
   - 应该看到：✅ 成功获取股票分组
   - 显示波段、短线、中长线的股票数量

2. 点击 **"2️⃣ 测试CR分析"**
   - 应该看到：✅ CR分析成功
   - 显示C点和R点数量

3. 点击 **"3️⃣ 测试回测"**
   - 应该看到：✅ 回测成功
   - 显示收益率统计

### 3. 使用批量回测

访问：`http://localhost:5000/batch_backtest.html`

1. **选择股性分组**：
   - 所有策略（包含全部股性）← 新增！
   - 波段策略
   - 短线策略
   - 中长线策略

2. **设置股票数量**：
   - 建议先测试 5-10 支股票
   - 最大支持 100 支

3. **开始回测**：
   - 点击"🚀 开始批量回测"按钮
   - 等待进度条完成

4. **查看结果**：
   - 汇总统计：平均收益率、总交易次数、胜率等
   - 详细表格：每支股票的具体数据

## 🐛 如果仍然出错

### 查看浏览器控制台

1. 按 **F12** 打开开发者工具
2. 切换到 **Console** 标签
3. 查看详细日志：

```
开始回测股票: 600519 贵州茅台
CR分析请求参数: {...}
CR分析响应状态: 200 OK  ← 应该是200，不是405
CR分析响应Content-Type: application/json
找到C点3个, R点2个
```

### 检查后端日志

在后端命令行窗口查看：
- 是否有Python错误
- 是否有数据库连接错误
- 是否有导入错误

## 📊 正常的回测结果示例

```
批量回测汇总
━━━━━━━━━━━━━━━━━━━━━━━━━━━
回测股票数：      20
平均收益率：      8.5%
总交易次数：      45
平均胜率：        65%
成功股票数：      18
失败股票数：      2
```

## ❓ 常见问题

### Q: 为什么有些股票显示"失败"？

**A:** 可能原因：
- 该股票没有30分钟K线数据（无法计算买入价）
- 该股票没有C点（没有买入信号）
- 数据库表不存在或数据不完整

这是正常现象，系统会在表格中显示具体失败原因。

### Q: "所有策略"会回测多少支股票？

**A:** 取决于你设置的数量限制：
- 默认20支，会从3种股性中取前20支
- 可以调整到100支

### Q: 回测需要多长时间？

**A:**
- 单支股票：约1-2秒
- 20支股票：约30-40秒
- 建议不要一次回测太多股票

## ✅ 检查清单

在提交问题前，请确认：

- [ ] 已重启后端服务
- [ ] 测试页面(test_api.html)全部通过
- [ ] 浏览器控制台没有红色错误
- [ ] 后端命令行没有错误信息
- [ ] 已选择股性分组和股票数量

## 🎯 成功标志

如果看到以下内容，说明一切正常：

1. ✅ 进度条从0%增长到100%
2. ✅ 汇总卡片显示统计数据
3. ✅ 表格中有绿色的"✓ 成功"标记
4. ✅ 控制台日志显示"200 OK"

---

**最后提醒：一定要重启后端服务！** 🔄

