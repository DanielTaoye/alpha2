# 插件5：急跌抢反弹

## 功能说明
这是一个**直接发C插件**，用于识别急跌后的反弹机会。当股票连续大幅下跌后出现反弹信号时，**直接触发C点**（买入信号），无需考虑基础分数。

## 插件类型
- **类型**：直接发C插件（非否决插件、非加分插件）
- **触发效果**：满足条件时**直接发C**（返回999分标记）
- **优先级**：高于其他扣分插件
- **位置**：`backend/domain/services/c_point_plugin_service.py`

## 触发条件

### 主要条件（满足其一）

#### 条件1：连续4日急跌
- **判断标准**：前4个交易日累计跌幅过大
- **主板阈值**：累计跌幅 < -20%
- **非主板阈值**：累计跌幅 < -25%

#### 条件2：连续5日阴线
- **判断标准**：前5个交易日连续阴线且累计跌幅过大
- **主板阈值**：累计跌幅 < -20%
- **非主板阈值**：累计跌幅 < -30%

### 叠加条件（满足其一即触发）

满足主要条件后，还需满足以下任一叠加条件：

#### 条件A：今日反弹信号
**所有要素必须同时满足：**
1. 今日成交量极度萎缩（相对第一个下跌日萎缩至20%以下）
2. 今日振幅 > 5%
3. 今日为触底反弹十字星 **或** 触底反弹阳线
   - 十字星定义：实体占比 < 1%
   - 阳线定义：收盘价 ≥ 开盘价

#### 条件B：昨日铺垫+今日反弹
**所有要素必须同时满足：**
1. 昨日成交量极度萎缩（相对第一个下跌日萎缩至20%以下）
2. 昨日为十字星（实体占比 < 1%）
3. 今日为阳线

## 实现逻辑

### 1. 主板/非主板判断
```python
is_main_board = stock_code.startswith((
    'SH600', 'SH601', 'SH603', 'SH605', 
    'SZ000', 'SZ001'
))
```

### 2. 历史数据获取
- 获取当日数据
- 获取前5个交易日数据（从缓存优先读取）
- 计算每日涨跌幅

### 3. 主要条件检查

#### 连续4日急跌
```python
cum_4days = sum(change_pcts[:4])
threshold = -20 if is_main_board else -25
if cum_4days < threshold:
    # 触发主要条件
    first_day_volume = prev_data_list[3].volume
```

#### 连续5日阴线
```python
all_bearish = all(data.close < data.open for data in prev_data_list[:5])
cum_5days = sum(change_pcts[:5])
threshold = -20 if is_main_board else -30
if all_bearish and cum_5days < threshold:
    # 触发主要条件
    first_day_volume = prev_data_list[4].volume
```

### 4. 叠加条件检查

#### 条件A：今日反弹
```python
# 计算量缩比例
volume_shrink = current_volume / first_day_volume

# 计算振幅
amplitude = (high - low) / pre_close * 100

# 判断十字星或阳线
is_doji = (abs(close - open) / close * 100) < 1
is_bullish = close >= open

# 触发条件
if volume_shrink <= 0.2 and amplitude > 5 and (is_doji or is_bullish):
    return +50分
```

#### 条件B：昨日铺垫+今日反弹
```python
# 昨日量缩
yesterday_volume_shrink = yesterday_volume / first_day_volume

# 昨日十字星
is_yesterday_doji = (abs(yesterday_close - yesterday_open) / yesterday_close * 100) < 1

# 今日阳线
is_current_bullish = current_close >= current_open

# 触发条件
if yesterday_volume_shrink <= 0.2 and is_yesterday_doji and is_current_bullish:
    return +50分
```

## 示例场景

### 场景1：连续4日急跌后今日反弹

**前4日情况：**
- Day -4: 跌5%, 成交量1000万
- Day -3: 跌6%, 成交量800万
- Day -2: 跌4%, 成交量600万
- Day -1: 跌6%, 成交量400万
- **累计跌幅：-21%（主板）**

**今日情况：**
- 成交量：150万（相对Day-4萎缩至15%）✓
- 振幅：7%（满足>5%）✓
- K线形态：十字星或阳线 ✓

**结果：触发插件，直接发C**

### 场景2：连续5日阴线后昨日铺垫今日反弹

**前5日情况：**
- Day -5: 阴线，跌4%, 成交量1500万
- Day -4: 阴线，跌5%, 成交量1200万
- Day -3: 阴线，跌3%, 成交量900万
- Day -2: 阴线，跌6%, 成交量600万
- Day -1: 阴线，十字星，成交量250万（萎缩至16.7%）
- **累计跌幅：-22%（主板）**

**今日情况：**
- K线形态：阳线 ✓

**结果：触发插件，直接发C**

## 日志输出

插件触发时的日志示例：

```log
[INFO] [插件-急跌抢反弹] SH600000 2024-11-14: 连续4日急跌(累计跌幅:-21.50%), 今日量缩至15.0%, 振幅7.20%, 阳线反弹, 直接发C
```

```log
[INFO] [插件-急跌抢反弹] SZ000001 2024-11-14: 连续5日阴线(累计跌幅:-22.80%), 昨日量缩至16.7%且为十字星, 今日阳线反弹, 直接发C
```

## 使用场景

### 适用情况
1. ✅ 市场大跌后的超跌反弹
2. ✅ 个股连续调整后的止跌信号
3. ✅ 成交量萎缩到极致后的缩量反弹
4. ✅ 恐慌盘释放完毕后的技术性反弹

### 注意事项
1. ⚠️ 此策略属于"抄底"策略，有一定风险
2. ⚠️ 需要结合其他指标综合判断
3. ⚠️ 反弹不等于反转，注意止损
4. ⚠️ 成交量是重要参考指标

## 技术要点

### 1. 性能优化
- 优先从缓存读取数据（避免重复查询数据库）
- 使用 `_get_previous_trading_dates_from_cache()` 获取历史交易日

### 2. 数据准确性
- 所有计算基于收盘价和昨收价
- 振幅计算使用昨收价作为基准
- 成交量对比使用第一个下跌日的成交量

### 3. 容错处理
- 数据不足时返回不触发
- 异常情况统一返回不触发
- 记录错误日志便于调试

## 代码位置

```
backend/domain/services/c_point_plugin_service.py
├── apply_plugins() - 第114-119行：调用插件
└── _check_sharp_drop_rebound() - 第445-572行：插件实现
```

## 测试建议

1. **找到连续大跌的股票**，检查是否能识别反弹信号
2. **验证直接发C逻辑**，确认触发后无论基础分多少都能发C
3. **测试优先级**，验证此插件触发后会忽略其他扣分插件
4. **测试边界情况**：
   - 恰好-20%/-25%跌幅
   - 成交量恰好20%
   - 振幅恰好5%
5. **测试主板/非主板**不同阈值

## 版本历史

- **v1.1** (2024-11-14)
  - **修改**：改为"直接发C"模式，不再是加分
  - 满足条件时直接返回999分，确保触发C点
  - 优先级高于其他扣分插件

- **v1.0** (2024-11-14)
  - 初始版本
  - 支持连续急跌和连续阴线两种主要条件
  - 支持今日反弹和昨日铺垫两种叠加条件

