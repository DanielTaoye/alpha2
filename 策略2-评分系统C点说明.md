# 策略2 - 评分系统C点说明

## 📊 策略概述

策略2是基于**评分系统**的C点计算方法，与策略1（赔率分+胜率分）独立并行运行。**总分≥70分即触发C点**。

### 策略特点
- ✅ **多维度评分**：均线、MACD、成交量、K线组合4个维度
- ✅ **独立触发**：不依赖策略1，可单独发C点
- ✅ **详细评分**：每个维度都有明确的分数标准
- ✅ **可视化标记**：用紫色矩形"策略2"标记区分策略1

## 🎯 评分体系（总分100分）

### 1. 均线总分：30分

**触发条件**（同时满足）：
- 5日线上穿10日线（MA5金叉MA10）
- 当前价格 > 20日均线价格

```
if (MA5昨 <= MA10昨 && MA5今 > MA10今 && 价格今 > MA20今):
    得分 = 30分
```

### 2. MACD总分：30分

**评分细则**：

| 项目 | 条件 | 分数 |
|------|------|------|
| DIF拐头向上 | 前天DIF>昨天DIF && 昨天DIF<今天DIF | 10分 |
| 金叉 | DIF上穿DEA | 10分 |
| 多头排列 | DIF > DEA > 0 且 MACD > 0 | 10分 |
| 强势多头 | 当日和前一日DIF > 前8日所有DIF | 5分* |
| 柱状图反转 | 前日蓝柱(MACD<0)，今日红柱(MACD>0) | 5分* |

*标注的项目触发后**5个交易日内持续有效**

**最高可得30分**（各项独立计算）

### 3. 成交量总分：30分

**仅看日K线，分档评分**：

| 成交量类型 | 分数 | 权重 |
|-----------|------|------|
| 温和放量（ABCD任意一种） | 30分 | 100% |
| 特殊型（H型） | 21分 | 70% |

```
if (包含A或B或C或D):
    得分 = 30分
elif (包含H):
    得分 = 21分
```

### 4. K线组合：10分

**触发条件**（同时满足）：
- **低位**：前30个交易日区间振幅>20%，且当前股价处于10%水位区间
- **多头K线组合**：出现任意多头K线形态

```
低位判断:
1. 计算前30日最高价max_high和最低价min_low
2. 振幅 = (max_high - min_low) / min_low
3. 10%水位 = min_low + (max_high - min_low) * 10%
4. 如果 振幅>20% 且 当前价格在[min_low, 10%水位]范围内，则为低位
```

### 5. 减分项：-50分

**触发条件**：
- 股价偏离10日均线 > 20%

```
偏离度 = |当前价格 - MA10| / MA10

if (偏离度 > 0.20):
    得分 = -50分
```

## 📈 评分示例

### 示例1：满分场景（100分）
```
均线：MA5金叉MA10 + 价格>MA20 = 30分
MACD：拐头10 + 金叉10 + 多头排列10 = 30分
成交量：温和放量(ABCD) = 30分
K线组合：低位 + 看涨吞没 = 10分
减分：无 = 0分
---
总分 = 100分 > 70分 → ✅ 触发C点
```

### 示例2：及格场景（75分）
```
均线：MA5金叉MA10 + 价格>MA20 = 30分
MACD：金叉10 + 强势多头5 = 15分
成交量：温和放量(A) = 30分
K线组合：未处于低位 = 0分
减分：无 = 0分
---
总分 = 75分 > 70分 → ✅ 触发C点
```

### 示例3：不及格场景（60分）
```
均线：MA5金叉MA10 + 价格>MA20 = 30分
MACD：多头排列10 = 10分
成交量：H型放量 = 21分
K线组合：无 = 0分
减分：偏离MA10 23% = -50分
---
总分 = 11分 < 70分 → ❌ 不触发
```

## 🏗️ 技术实现

### 后端架构

```
CR点控制器
    ↓ 加载数据
├─ MA数据（5/10/20日均线）
├─ MACD数据（DIF/DEA/MACD）
├─ 成交量类型（从daily_chance表）
└─ 多头K线组合（从daily_chance表）
    ↓ 传递
Strategy2Service.check_strategy2()
    ↓ 评分
├─ _calculate_ma_score()        # 均线30分
├─ _calculate_macd_score()      # MACD30分
├─ _calculate_volume_score()    # 成交量30分
├─ _calculate_kline_score()     # K线组合10分
└─ _calculate_penalty()         # 减分-50分
    ↓ 判断
if (总分 >= 70):
    返回 触发=True
```

### 核心文件

- `backend/domain/services/strategy2_service.py` - 策略2计算服务
- `backend/application/services/cr_point_service.py` - CR点服务（集成策略2）
- `backend/interfaces/controllers/cr_point_controller.py` - 控制器（加载数据）
- `frontend/js/app.js` - 前端显示（紫色矩形标记）

## 🎨 前端显示

### 策略2 C点标记
- **形状**：矩形（区别策略1的圆形）
- **颜色**：紫色 `#9C27B0`
- **标签**：`策略2`
- **位置**：K线下方（略低于策略1避免重叠）
- **层级**：z=101（比策略1稍高）

### Tooltip信息
```
日期: 2025-11-17
策略: 策略2: 总分75分 (均线30分, MACD15分, 成交量30分)
```

### 统计显示
```
C点(买入): 8 (策略1:5, 策略2:3) | R点(卖出): 2
```

## 💡 使用建议

### 策略1 vs 策略2

| 特性 | 策略1 | 策略2 |
|------|-------|-------|
| 核心逻辑 | 赔率分 + 胜率分 | 多维度评分系统 |
| 触发条件 | 总分≥70 + 插件调整 | 总分≥70 |
| 数据依赖 | daily_chance表 | daily_chance + MA + MACD |
| 优势 | 简单高效，基于历史回测 | 综合技术指标，信号更全面 |
| 适用场景 | 趋势行情，价值投资 | 技术面强势，多头趋势 |

### 组合使用

1. **双重确认**：策略1和策略2同时触发 → 超强买入信号！
2. **技术优先**：策略2触发时，优先关注MACD和均线配合
3. **风险控制**：策略2触发后，注意偏离度，避免追高
4. **时机把握**：低位(10%水位) + 策略2 = 最佳买入时机

## 🧪 测试验证

### 测试脚本
```bash
python backend/scripts/test_strategy2.py
```

### 测试结果
```
场景1: 温和放量 + 多头组合
  触发: 否
  得分: 30分
  原因: 策略2总分: 30分 (成交量30分(温和放量))

场景2: H型放量 + 多头组合
  触发: 否
  得分: 21分
  原因: 策略2总分: 21分 (成交量21分(H型放量))
```

## ⚙️ 配置说明

### 可调参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| 触发阈值 | 70分 | 总分>=70触发C点 |
| 均线周期 | 5/10/20 | 短中长期均线 |
| MACD参数 | 12/26/9 | 快线/慢线/信号线 |
| 时间窗口 | 5个交易日 | MACD加分持续时间 |
| 低位水位 | 10% | 低位判断的水位线 |
| 低位振幅 | 20% | 低位判断的振幅阈值 |
| 偏离阈值 | 20% | 触发减分的偏离度 |

### 调整建议

- **保守型**：触发阈值提高至80分
- **激进型**：触发阈值降低至60分
- **短线**：低位水位提高至20%
- **中长线**：偏离阈值放宽至30%

## ✅ 功能清单

- [x] 策略2评分服务实现
- [x] 均线得分计算（30分）
- [x] MACD得分计算（30分，含时间窗口）
- [x] 成交量得分计算（30/21分）
- [x] K线组合得分计算（10分）
- [x] 减分项计算（-50分）
- [x] CR点服务集成策略2
- [x] 控制器加载成交量和多头组合数据
- [x] 前端紫色矩形标记"策略2"
- [x] 前端统计显示区分策略1和策略2
- [x] 测试脚本验证
- [x] 文档编写

## 🔮 后续优化

### 可扩展功能
1. **动态权重**：根据市场环境调整各维度权重
2. **机器学习**：基于历史数据优化评分模型
3. **策略3/4/5**：开发更多策略，形成策略矩阵
4. **策略融合**：多策略投票，提高准确率
5. **回测系统**：验证策略2的实际收益率

---

**实现日期**：2025-11-17  
**版本**：v1.0  
**状态**：✅ 已完成并测试通过

